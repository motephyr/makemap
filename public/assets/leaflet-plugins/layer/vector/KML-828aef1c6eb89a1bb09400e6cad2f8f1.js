L.KML=L.FeatureGroup.extend({options:{async:!0},initialize:function(e,t){L.Util.setOptions(this,t),this._kml=e,this._layers={},e&&this.addKML(e,t,this.options.async)},loadXML:function(e,t,n,o){void 0===o&&(o=this.options.async),void 0===n&&(n=this.options);var a=new window.XMLHttpRequest;a.open("GET",e,o);try{a.overrideMimeType("text/xml")}catch(r){}a.onreadystatechange=function(){4===a.readyState&&200===a.status&&t(a.responseXML,n)},a.send(null)},addKML:function(e,t,n){var o=this,a=function(e,t){o._addKML(e,t)};this.loadXML(e,a,t,n)},_addKML:function(e){var t=L.KML.parseKML(e);if(t&&t.length){for(var n=0;n<t.length;n++)this.fire("addlayer",{layer:t[n]}),this.addLayer(t[n]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e){var t=this.parseStyle(e);this.parseStyleMap(e,t);for(var n,o=e.getElementsByTagName("Folder"),a=[],r=0;r<o.length;r++)this._check_folder(o[r])&&(n=this.parseFolder(o[r],t),n&&a.push(n));o=e.getElementsByTagName("Placemark");for(var s=0;s<o.length;s++)this._check_folder(o[s])&&(n=this.parsePlacemark(o[s],e,t),n&&a.push(n));o=e.getElementsByTagName("GroundOverlay");for(var i=0;i<o.length;i++)n=this.parseGroundOverlay(o[i]),n&&a.push(n);return a},_check_folder:function(e,t){for(e=e.parentElement;e&&"Folder"!==e.tagName;)e=e.parentElement;return!e||e===t},parseStyle:function(e){function t(e){for(var n={},o=0;o<e.childNodes.length;o++){var r=e.childNodes[o],s=r.tagName;if(a[s])if("hotSpot"===s)for(var i=0;i<r.attributes.length;i++)n[r.attributes[i].name]=r.attributes[i].nodeValue;else{var l=r.childNodes[0].nodeValue;"color"===s?(n.opacity=parseInt(l.substring(0,2),16)/255,n.color="#"+l.substring(6,8)+l.substring(4,6)+l.substring(2,4)):"width"===s?n.weight=l:"Icon"===s?(g=t(r),g.href&&(n.href=g.href)):"href"===s&&(n.href=l)}}return n}for(var n={},o=e.getElementsByTagName("Style"),a={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0},r=0;r<o.length;r++){var s,i=o[r],l={},h={},g={};s=i.getElementsByTagName("LineStyle"),s&&s[0]&&(l=t(s[0])),s=i.getElementsByTagName("PolyStyle"),s&&s[0]&&(h=t(s[0])),h.color&&(l.fillColor=h.color),h.opacity&&(l.fillOpacity=h.opacity),s=i.getElementsByTagName("IconStyle"),s&&s[0]&&(g=t(s[0])),g.href&&(l.icon=new L.KMLIcon({iconUrl:g.href,shadowUrl:null,iconAnchorRef:{x:g.x,y:g.y},iconAnchorType:{x:g.xunits,y:g.yunits}})),n["#"+i.getAttribute("id")]=l}return n},parseStyleMap:function(e,t){for(var n=e.getElementsByTagName("StyleMap"),o=0;o<n.length;o++){var a,r,s,i=n[o];a=i.getElementsByTagName("key"),a&&a[0]&&(r=a[0].textContent),a=i.getElementsByTagName("styleUrl"),a&&a[0]&&(s=a[0].textContent),"normal"===r&&(t["#"+i.getAttribute("id")]=t[s])}},parseFolder:function(e,t){var n,o,a=[];n=e.getElementsByTagName("Folder");for(var r=0;r<n.length;r++)this._check_folder(n[r],e)&&(o=this.parseFolder(n[r],t),o&&a.push(o));n=e.getElementsByTagName("Placemark");for(var s=0;s<n.length;s++)this._check_folder(n[s],e)&&(o=this.parsePlacemark(n[s],e,t),o&&a.push(o));n=e.getElementsByTagName("GroundOverlay");for(var i=0;i<n.length;i++)this._check_folder(n[i],e)&&(o=this.parseGroundOverlay(n[i]),o&&a.push(o));if(a.length)return 1===a.length?a[0]:new L.FeatureGroup(a)},parsePlacemark:function(e,t,n){var o,a,r,s={};for(r=e.getElementsByTagName("styleUrl"),o=0;o<r.length;o++){var i=r[o].childNodes[0].nodeValue;for(var l in n[i])s[l]=n[i][l]}var h=[],g=["LineString","Polygon","Point"];for(a in g){var c=g[a];for(r=e.getElementsByTagName(c),o=0;o<r.length;o++){var d=this["parse"+c](r[o],t,s);d&&h.push(d)}}if(h.length){var u=h[0];h.length>1&&(u=new L.FeatureGroup(h));var y,f="";for(r=e.getElementsByTagName("name"),r.length&&r[0].childNodes.length&&(y=r[0].childNodes[0].nodeValue),r=e.getElementsByTagName("description"),o=0;o<r.length;o++)for(a=0;a<r[o].childNodes.length;a++)f+=r[o].childNodes[a].nodeValue;return y&&u.bindPopup("<h2>"+y+"</h2>"+f),u}},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,n){var o=this.parseCoords(e);if(o.length)return new L.Polyline(o,n)},parsePoint:function(e,t,n){var o=e.getElementsByTagName("coordinates");if(o.length){var a=o[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(a[1],a[0]),n)}},parsePolygon:function(e,t,n){var o,a,r,s=[],i=[];for(o=e.getElementsByTagName("outerBoundaryIs"),a=0;a<o.length;a++)r=this.parseCoords(o[a]),r&&s.push(r);for(o=e.getElementsByTagName("innerBoundaryIs"),a=0;a<o.length;a++)r=this.parseCoords(o[a]),r&&i.push(r);return s.length?(n.fillColor&&(n.fill=!0),1===s.length?new L.Polygon(s.concat(i),n):new L.MultiPolygon(s,n)):void 0},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),n=[],o=0;o<t.length;o++)n=n.concat(this._read_coords(t[o]));return n},_read_coords:function(e){var t,n="",o=[];for(t=0;t<e.childNodes.length;t++)n+=e.childNodes[t].nodeValue;for(n=n.split(/[\s\n]+/),t=0;t<n.length;t++){var a=n[t].split(",");a.length<2||o.push(new L.LatLng(a[1],a[0]))}return o},parseGroundOverlay:function(e){function t(e){for(var n={},o={},r=0;r<e.childNodes.length;r++){var s=e.childNodes[r],i=s.tagName;if(a[i]){var l=s.childNodes[0].nodeValue;"Icon"===i?(o=t(s),o.href&&(n.href=o.href)):"href"===i?n.href=l:"color"===i&&(n.opacity=parseInt(l.substring(0,2),16)/255,n.color="#"+l.substring(6,8)+l.substring(4,6)+l.substring(2,4))}}return n}var n=e.getElementsByTagName("LatLonBox")[0],o=new L.LatLngBounds([n.getElementsByTagName("south")[0].childNodes[0].nodeValue,n.getElementsByTagName("west")[0].childNodes[0].nodeValue],[n.getElementsByTagName("north")[0].childNodes[0].nodeValue,n.getElementsByTagName("east")[0].childNodes[0].nodeValue]),a={Icon:!0,href:!0,color:!0},r={};if(r=t(e),void 0!==n.getElementsByTagName("rotation")[0]){var s=n.getElementsByTagName("rotation")[0].childNodes[0].nodeValue;r.rotation=parseFloat(s)}return new L.RotatedImageOverlay(r.href,o,{opacity:r.opacity,angle:r.rotation})}}),L.KMLIcon=L.Icon.extend({createIcon:function(){var e=this._createIcon("icon");return e.onload=function(){var t=e;this.style.width=t.width+"px",this.style.height=t.height+"px",("UNITS_FRACTION"===this.anchorType.x||"fraction"===this.anchorType.x)&&(e.style.marginLeft=-this.anchor.x*t.width+"px"),("UNITS_FRACTION"===this.anchorType.y||"fraction"===this.anchorType.x)&&(e.style.marginTop=-(1-this.anchor.y)*t.height+"px"),this.style.display=""},e},_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]),e.anchor=this.options.iconAnchorRef,e.anchorType=this.options.iconAnchorType}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}}),L.RotatedImageOverlay=L.ImageOverlay.extend({options:{angle:0},_reset:function(){L.ImageOverlay.prototype._reset.call(this),this._rotate()},_animateZoom:function(e){L.ImageOverlay.prototype._animateZoom.call(this,e),this._rotate()},_rotate:function(){if(L.DomUtil.TRANSFORM)this._image.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(L.Browser.ie){var e=this.options.angle*(Math.PI/180),t=Math.cos(e),n=Math.sin(e);this._image.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+t+", M12="+-n+", M21="+n+", M22="+t+")"}},getBounds:function(){return this._bounds}});