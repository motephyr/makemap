L.OSM=L.FeatureGroup.extend({options:{async:!0,forceAll:!1},initialize:function(t,e){L.Util.setOptions(this,e),this._url=t,this._layers={},t&&this.addXML(t,e,this.options.async)},loadXML:function(t,e,n,a){void 0===a&&(a=this.options.async),void 0===n&&(n=this.options);var r=new window.XMLHttpRequest;r.open("GET",t,a),r.overrideMimeType("text/xml"),r.onreadystatechange=function(){4===r.readyState&&200===r.status&&e(r.responseXML,n)},r.send(null)},addXML:function(t,e,n){var a=this,r=function(t,e){a._addXML(t,e)};this.loadXML(t,r,e,n)},_addXML:function(t,e){var n=this.parseOSM(t,e);n&&(this.addLayer(n),this.fire("loaded"))},parseOSM:function(t,e){var n,a,r,s=[],i={},o={},l=!1;for(a=t.getElementsByTagName("node"),n=0;n<a.length;n++){var g=this.parse_node(a[n],t,e);if(void 0!==g&&(i[g.osmid]=g,this.options.forceAll||g.tags.length)){var h=this.named_node(g,e);r||(r=h.getLatLng()),this.parse_name(h,g,"Node")&&(l=!0),s.push(h)}}for(a=t.getElementsByTagName("way"),n=0;n<a.length&&!(n>10);n++){var u=this.parse_way(a[n],i,e);u&&(r||(r=u.getLatLngs()[0]),this.parse_name(u,u,"Way")&&(l=!0),s.push(u),o[u.osmid]=u)}for(a=t.getElementsByTagName("relation"),n=0;n<a.length&&!(n>10);n++){var d=this.parse_relation(a[n],o,e);d&&(r||(r=d.getLatLngs()[0]),this.parse_name(d,d,"Relation")&&(l=!0),s.push(d))}if(s.length){var p=s[0];return s.length>1&&(p=new L.FeatureGroup(s)),l||this.parse_name(t,p),p.focusPoint=r,p}},parse_name:function(t,e,n){if(console.info("parse name"),console.info(this.options),this.options.forceAll||e.tags&&e.tags.length){var a,r="<table>";for(a=0;a<e.tags.length;a++){var s=e.tags[a];r+="<tr><td>"+s.k+"</td><td>=</td><td>"+s.v+"</td></tr>"}return r+="</table>",r="<h2>"+n+" "+e.osmid+"</h2>"+r,t&&t.bindPopup(r),r}},parse_tags:function(t){for(var e=[],n=t.getElementsByTagName("tag"),a=0;a<n.length;a++)e.push({k:n[a].getAttribute("k"),v:n[a].getAttribute("v")});return e},parse_node:function(t){var e={osmid:t.getAttribute("id"),lat:t.getAttribute("lat"),lon:t.getAttribute("lon")};return e.ll=new L.LatLng(e.lat,e.lon),e.tags=this.parse_tags(t),e},parse_way:function(t,e,n){var a=t.getElementsByTagName("nd");if(a.length){for(var r=[],s=0;s<a.length;s++){var i=a[s].getAttribute("ref"),o=e[i];if(!o)return;r.push(o.ll)}var l=new L.Polyline(r,n);return l.tags=this.parse_tags(t),l.osmid=t.getAttribute("id"),l}},parse_relation:function(t,e,n){var a=t.getElementsByTagName("member");if(a.length){var r,s,i=[],o=this.parse_tags(t);for(s=0;s<o.length;s++)"type"===o[s].k&&(r=o[s].v);if("multipolygon"===r||"boundary"===r||"waterway"===r){for(s=0;s<a.length;s++){var l=a[s].getAttribute("type"),g=a[s].getAttribute("ref");if("way"===l){var h=e[g];if(console.info("Way: "+g+" "+h),!h)return;i.push(h)}}if(console.info("Coords: "+i.length),i.length){var u=new L.MultiPolyline(i,n);return u.tags=this.parse_tags(t),u.osmid=t.getAttribute("id"),u}}}},named_node:function(t,e){var n=new L.Marker(new L.LatLng(t.lat,t.lon),e);return n}});