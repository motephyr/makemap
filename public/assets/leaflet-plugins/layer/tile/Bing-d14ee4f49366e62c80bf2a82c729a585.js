L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(t,i){L.Util.setOptions(this,i),this._key=t,this._url=null,this.meta={},this.loadMetadata()},tile2quad:function(t,i,e){for(var o="",a=e;a>0;a--){var r=0,n=1<<a-1;0!==(t&n)&&(r+=1),0!==(i&n)&&(r+=2),o+=r}return o},getTileUrl:function(t){var i=this._getZoomForUrl(),e=this.options.subdomains,o=this.options.subdomains[Math.abs((t.x+t.y)%e.length)];return this._url.replace("{subdomain}",o).replace("{quadkey}",this.tile2quad(t.x,t.y,i)).replace("{culture}",this.options.culture)},loadMetadata:function(){var t=this,i="_bing_metadata_"+L.Util.stamp(this);window[i]=function(e){t.meta=e,window[i]=void 0;var o=document.getElementById(i);return o.parentNode.removeChild(o),e.errorDetails?void(window.console&&console.log("Leaflet Bing Plugin Error - Got metadata: "+e.errorDetails)):void t.initMetadata()};var e=document.location.protocol+"//dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+i+"&key="+this._key+"&UriScheme="+document.location.protocol.slice(0,-1),o=document.createElement("script");o.type="text/javascript",o.src=e,o.id=i,document.getElementsByTagName("head")[0].appendChild(o)},initMetadata:function(){var t=this.meta.resourceSets[0].resources[0];if(this.options.subdomains=t.imageUrlSubdomains,this._url=t.imageUrl,this._providers=[],t.imageryProviders)for(var i=0;i<t.imageryProviders.length;i++)for(var e=t.imageryProviders[i],o=0;o<e.coverageAreas.length;o++){var a=e.coverageAreas[o],r={zoomMin:a.zoomMin,zoomMax:a.zoomMax,active:!1},n=new L.LatLngBounds(new L.LatLng(a.bbox[0]+.01,a.bbox[1]+.01),new L.LatLng(a.bbox[2]-.01,a.bbox[3]-.01));r.bounds=n,r.attrib=e.attribution,this._providers.push(r)}this._update()},_update:function(){null!==this._url&&this._map&&(this._update_attribution(),L.TileLayer.prototype._update.apply(this,[]))},_update_attribution:function(){for(var t=this._map.getBounds(),i=this._map.getZoom(),e=0;e<this._providers.length;e++){var o=this._providers[e];i<=o.zoomMax&&i>=o.zoomMin&&t.intersects(o.bounds)?(!o.active&&this._map.attributionControl&&this._map.attributionControl.addAttribution(o.attrib),o.active=!0):(o.active&&this._map.attributionControl&&this._map.attributionControl.removeAttribution(o.attrib),o.active=!1)}},onRemove:function(t){for(var i=0;i<this._providers.length;i++){var e=this._providers[i];e.active&&this._map.attributionControl&&(this._map.attributionControl.removeAttribution(e.attrib),e.active=!1)}L.TileLayer.prototype.onRemove.apply(this,[t])}}),L.bingLayer=function(t,i){return new L.BingLayer(t,i)};