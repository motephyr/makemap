L.Control.Permalink.include({initialize_layer:function(){this.on("update",this._set_layer,this),this.on("add",this._onadd_layer,this)},_onadd_layer:function(){this._map.on("layeradd",this._update_layer,this),this._map.on("layerremove",this._update_layer,this),this._update_layer()},_update_layer:function(){if(this.options.layers){var a=this.options.layers.currentBaseLayer();a&&this._update({layer:a.name})}},_set_layer:function(a){var e=a.params;this.options.layers&&e.layer&&this.options.layers.chooseBaseLayer(e.layer)}}),L.Control.Layers.include({chooseBaseLayer:function(a){var e,r;for(var s in this._layers)this._layers.hasOwnProperty(s)&&(r=this._layers[s],r.overlay||r.name!==a||(e=r.layer));if(e&&!this._map.hasLayer(e)){for(var t in this._layers)this._layers.hasOwnProperty(t)&&(r=this._layers[t],!r.overlay&&this._map.hasLayer(r.layer)&&this._map.removeLayer(r.layer));this._map.addLayer(e),this._update()}},currentBaseLayer:function(){for(var a in this._layers)if(this._layers.hasOwnProperty(a)){var e=this._layers[a];if(!e.overlay&&!e.overlay&&this._map.hasLayer(e.layer))return e}}});