L.Control.Permalink=L.Control.extend({includes:L.Mixin.Events,options:{position:"bottomleft",useAnchor:!0,useLocation:!1,text:"Permalink"},initialize:function(t){L.Util.setOptions(this,t),this._params={},this._set_urlvars(),this.on("update",this._set_center,this);for(var i in this)"string"==typeof i&&0===i.indexOf("initialize_")&&this[i]()},onAdd:function(t){if(this._container=L.DomUtil.create("div","leaflet-control-attribution leaflet-control-permalink"),L.DomEvent.disableClickPropagation(this._container),this._map=t,this._href=L.DomUtil.create("a",null,this._container),this._href.innerHTML=this.options.text,t.on("moveend",this._update_center,this),this.fire("update",{params:this._params}),this._update_center(),this.options.useAnchor&&"onhashchange"in window){var i=this,n=window.onhashchange;window.onhashchange=function(){return i._set_urlvars(),n?n():void 0}}return this.fire("add",{map:t}),this._container},_update_center:function(){if(this._map){var t=this._round_point(this._map.getCenter());this._update({zoom:this._map.getZoom(),lat:t.lat,lon:t.lng})}},_update_href:function(){var t=L.Util.getParamString(this._params),i="?";this.options.useAnchor&&(i="#");var n=this._url_base+i+t.slice(1);return this._href&&this._href.setAttribute("href",n),this.options.useLocation&&location.replace("#"+t.slice(1)),n},_round_point:function(t){var i=this._map.getBounds(),n=this._map.getSize(),e=i.getNorthEast(),r=i.getSouthWest(),a=function(t,i){if(0===i)return t;for(var n=1;1>i&&i>-1;)t*=10,i*=10,n*=10;return Math.floor(t)/n};return t.lat=a(t.lat,(e.lat-r.lat)/n.y),t.lng=a(t.lng,(e.lng-r.lng)/n.x),t},_update:function(t){for(var i in t)t.hasOwnProperty(i)&&(null!==t[i]&&void 0!==t[i]?this._params[i]=t[i]:delete this._params[i]);this._update_href()},_set_urlvars:function(){function t(t,i){for(var n in t)if(t.hasOwnProperty(n)&&t[n]!==i[n])return!1;return!0}this._url_base=window.location.href.split("#")[0].split("?")[0];var i;i=L.UrlUtil.queryParse(this.options.useAnchor?L.UrlUtil.hash():L.UrlUtil.query()),t(i,this._params)&&t(this._params,i)||(this._params=i,this._update_href(),this.fire("update",{params:this._params}))},_set_center:function(t){var i=t.params;void 0!==i.zoom&&void 0!==i.lat&&void 0!==i.lon&&this._map.setView(new L.LatLng(i.lat,i.lon),i.zoom)}}),L.UrlUtil={queryParse:function(t){var i={},n="&";-1!==t.search("&amp;")&&(n="&amp;");for(var e=t.split(n),r=0;r<e.length;r++){var a=e[r].split("=");2===a.length&&(i[a[0]]=decodeURI(a[1]))}return i},query:function(){var t=window.location.href.split("#")[0],i=t.indexOf("?");return 0>i?"":t.slice(i+1)},hash:function(){return window.location.hash.slice(1)},updateParamString:function(t,i){var n=L.UrlUtil.queryParse(t);for(var e in i)i.hasOwnProperty(e)&&(n[e]=i[e]);return L.Util.getParamString(n).slice(1)}};