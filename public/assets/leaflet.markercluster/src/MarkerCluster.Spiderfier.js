L.MarkerCluster.include({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied!==this&&!this._group._inZoomAnimation){var t,e=this.getAllChildMarkers(),i=this._group,r=i._map,n=r.latLngToLayerPoint(this._latlng);this._group._unspiderfy(),this._group._spiderfied=this,e.length>=this._circleSpiralSwitchover?t=this._generatePointsSpiral(e.length,n):(n.y+=10,t=this._generatePointsCircle(e.length,n)),this._animationSpiderfy(e,t)}},unspiderfy:function(t){this._group._inZoomAnimation||(this._animationUnspiderfy(t),this._group._spiderfied=null)},_generatePointsCircle:function(t,e){var i,r,n=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t),s=n/this._2PI,a=this._2PI/t,o=[];for(o.length=t,i=t-1;i>=0;i--)r=this._circleStartAngle+i*a,o[i]=new L.Point(e.x+s*Math.cos(r),e.y+s*Math.sin(r))._round();return o},_generatePointsSpiral:function(t,e){var i,r=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthStart,n=this._group.options.spiderfyDistanceMultiplier*this._spiralFootSeparation,s=this._group.options.spiderfyDistanceMultiplier*this._spiralLengthFactor,a=0,o=[];for(o.length=t,i=t-1;i>=0;i--)a+=n/r+5e-4*i,o[i]=new L.Point(e.x+r*Math.cos(a),e.y+r*Math.sin(a))._round(),r+=this._2PI*s/a;return o},_noanimationUnspiderfy:function(){var t,e,i=this._group,r=i._map,n=i._featureGroup,s=this.getAllChildMarkers();for(this.setOpacity(1),e=s.length-1;e>=0;e--)t=s[e],n.removeLayer(t),t._preSpiderfyLatlng&&(t.setLatLng(t._preSpiderfyLatlng),delete t._preSpiderfyLatlng),t.setZIndexOffset&&t.setZIndexOffset(0),t._spiderLeg&&(r.removeLayer(t._spiderLeg),delete t._spiderLeg);i._spiderfied=null}}),L.MarkerCluster.include(L.DomUtil.TRANSITION?{SVG_ANIMATION:function(){return document.createElementNS("http://www.w3.org/2000/svg","animate").toString().indexOf("SVGAnimate")>-1}(),_animationSpiderfy:function(t,e){var i,r,n,s,a=this,o=this._group,p=o._map,_=o._featureGroup,h=p.latLngToLayerPoint(this._latlng);for(i=t.length-1;i>=0;i--)r=t[i],r.setOpacity?(r.setZIndexOffset(1e6),r.setOpacity(0),_.addLayer(r),r._setPos(h)):_.addLayer(r);o._forceLayout(),o._animationStart();var d=L.Path.SVG?0:.3,f=L.Path.SVG_NS;for(i=t.length-1;i>=0;i--)if(s=p.layerPointToLatLng(e[i]),r=t[i],r._preSpiderfyLatlng=r._latlng,r.setLatLng(s),r.setOpacity&&r.setOpacity(1),n=new L.Polyline([a._latlng,s],{weight:1.5,color:"#222",opacity:d}),p.addLayer(n),r._spiderLeg=n,L.Path.SVG&&this.SVG_ANIMATION){var l=n._path.getTotalLength();n._path.setAttribute("stroke-dasharray",l+","+l);var u=document.createElementNS(f,"animate");u.setAttribute("attributeName","stroke-dashoffset"),u.setAttribute("begin","indefinite"),u.setAttribute("from",l),u.setAttribute("to",0),u.setAttribute("dur",.25),n._path.appendChild(u),u.beginElement(),u=document.createElementNS(f,"animate"),u.setAttribute("attributeName","stroke-opacity"),u.setAttribute("attributeName","stroke-opacity"),u.setAttribute("begin","indefinite"),u.setAttribute("from",0),u.setAttribute("to",.5),u.setAttribute("dur",.25),n._path.appendChild(u),u.beginElement()}if(a.setOpacity(.3),L.Path.SVG)for(this._group._forceLayout(),i=t.length-1;i>=0;i--)r=t[i]._spiderLeg,r.options.opacity=.5,r._path.setAttribute("stroke-opacity",.5);setTimeout(function(){o._animationEnd(),o.fire("spiderfied")},200)},_animationUnspiderfy:function(t){var e,i,r,n=this._group,s=n._map,a=n._featureGroup,o=t?s._latLngToNewLayerPoint(this._latlng,t.zoom,t.center):s.latLngToLayerPoint(this._latlng),p=this.getAllChildMarkers(),_=L.Path.SVG&&this.SVG_ANIMATION;for(n._animationStart(),this.setOpacity(1),i=p.length-1;i>=0;i--)e=p[i],e._preSpiderfyLatlng&&(e.setLatLng(e._preSpiderfyLatlng),delete e._preSpiderfyLatlng,e.setOpacity?(e._setPos(o),e.setOpacity(0)):a.removeLayer(e),_&&(r=e._spiderLeg._path.childNodes[0],r.setAttribute("to",r.getAttribute("from")),r.setAttribute("from",0),r.beginElement(),r=e._spiderLeg._path.childNodes[1],r.setAttribute("from",.5),r.setAttribute("to",0),r.setAttribute("stroke-opacity",0),r.beginElement(),e._spiderLeg._path.setAttribute("stroke-opacity",0)));setTimeout(function(){var t=0;for(i=p.length-1;i>=0;i--)e=p[i],e._spiderLeg&&t++;for(i=p.length-1;i>=0;i--)e=p[i],e._spiderLeg&&(e.setOpacity&&(e.setOpacity(1),e.setZIndexOffset(0)),t>1&&a.removeLayer(e),s.removeLayer(e._spiderLeg),delete e._spiderLeg);n._animationEnd()},200)}}:{_animationSpiderfy:function(t,e){var i,r,n,s,a=this._group,o=a._map,p=a._featureGroup;for(i=t.length-1;i>=0;i--)s=o.layerPointToLatLng(e[i]),r=t[i],r._preSpiderfyLatlng=r._latlng,r.setLatLng(s),r.setZIndexOffset&&r.setZIndexOffset(1e6),p.addLayer(r),n=new L.Polyline([this._latlng,s],{weight:1.5,color:"#222"}),o.addLayer(n),r._spiderLeg=n;this.setOpacity(.3),a.fire("spiderfied")},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}}),L.MarkerClusterGroup.include({_spiderfied:null,_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this),this._map.options.zoomAnimation&&this._map.on("zoomstart",this._unspiderfyZoomStart,this),this._map.on("zoomend",this._noanimationUnspiderfy,this),L.Path.SVG&&!L.Browser.touch&&this._map._initPathRoot()},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this),this._map.off("zoomstart",this._unspiderfyZoomStart,this),this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._unspiderfy()},_unspiderfyZoomStart:function(){this._map&&this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(t){L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")||(this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._unspiderfy(t))},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(t){this._spiderfied&&this._spiderfied.unspiderfy(t)},_noanimationUnspiderfy:function(){this._spiderfied&&this._spiderfied._noanimationUnspiderfy()},_unspiderfyLayer:function(t){t._spiderLeg&&(this._featureGroup.removeLayer(t),t.setOpacity(1),t.setZIndexOffset(0),this._map.removeLayer(t._spiderLeg),delete t._spiderLeg)}});