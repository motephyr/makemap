L.MarkerCluster=L.Marker.extend({initialize:function(t,i,e,s){L.Marker.prototype.initialize.call(this,e?e._cLatLng||e.getLatLng():new L.LatLng(0,0),{icon:this}),this._group=t,this._zoom=i,this._markers=[],this._childClusters=[],this._childCount=0,this._iconNeedsUpdate=!0,this._bounds=new L.LatLngBounds,e&&this._addChild(e),s&&this._addChild(s)},getAllChildMarkers:function(t){t=t||[];for(var i=this._childClusters.length-1;i>=0;i--)this._childClusters[i].getAllChildMarkers(t);for(var e=this._markers.length-1;e>=0;e--)t.push(this._markers[e]);return t},getChildCount:function(){return this._childCount},zoomToBounds:function(){for(var t,i=this._childClusters.slice(),e=this._group._map,s=e.getBoundsZoom(this._bounds),n=this._zoom+1,r=e.getZoom();i.length>0&&s>n;){n++;var o=[];for(t=0;t<i.length;t++)o=o.concat(i[t]._childClusters);i=o}s>n?this._group._map.setView(this._latlng,n):r>=s?this._group._map.setView(this._latlng,r+1):this._group._map.fitBounds(this._bounds)},getBounds:function(){var t=new L.LatLngBounds;return t.extend(this._bounds),t},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(t,i){this._iconNeedsUpdate=!0,this._expandBounds(t),t instanceof L.MarkerCluster?(i||(this._childClusters.push(t),t.__parent=this),this._childCount+=t._childCount):(i||this._markers.push(t),this._childCount++),this.__parent&&this.__parent._addChild(t,!0)},_expandBounds:function(t){var i,e=t._wLatLng||t._latlng;t instanceof L.MarkerCluster?(this._bounds.extend(t._bounds),i=t._childCount):(this._bounds.extend(e),i=1),this._cLatLng||(this._cLatLng=t._cLatLng||e);var s=this._childCount+i;this._wLatLng?(this._wLatLng.lat=(e.lat*i+this._wLatLng.lat*this._childCount)/s,this._wLatLng.lng=(e.lng*i+this._wLatLng.lng*this._childCount)/s):this._latlng=this._wLatLng=new L.LatLng(e.lat,e.lng)},_addToMap:function(t){t&&(this._backupLatlng=this._latlng,this.setLatLng(t)),this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(t,i,e){this._recursively(t,0,e-1,function(t){var e,s,n=t._markers;for(e=n.length-1;e>=0;e--)s=n[e],s._icon&&(s._setPos(i),s.setOpacity(0))},function(t){var e,s,n=t._childClusters;for(e=n.length-1;e>=0;e--)s=n[e],s._icon&&(s._setPos(i),s.setOpacity(0))})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(t,i,e){this._recursively(t,e,0,function(s){s._recursivelyAnimateChildrenIn(t,s._group._map.latLngToLayerPoint(s.getLatLng()).round(),i),s._isSingleParent()&&i-1===e?(s.setOpacity(1),s._recursivelyRemoveChildrenFromMap(t,i)):s.setOpacity(0),s._addToMap()})},_recursivelyBecomeVisible:function(t,i){this._recursively(t,0,i,null,function(t){t.setOpacity(1)})},_recursivelyAddChildrenToMap:function(t,i,e){this._recursively(e,-1,i,function(s){if(i!==s._zoom)for(var n=s._markers.length-1;n>=0;n--){var r=s._markers[n];e.contains(r._latlng)&&(t&&(r._backupLatlng=r.getLatLng(),r.setLatLng(t),r.setOpacity&&r.setOpacity(0)),s._group._featureGroup.addLayer(r))}},function(i){i._addToMap(t)})},_recursivelyRestoreChildPositions:function(t){for(var i=this._markers.length-1;i>=0;i--){var e=this._markers[i];e._backupLatlng&&(e.setLatLng(e._backupLatlng),delete e._backupLatlng)}if(t-1===this._zoom)for(var s=this._childClusters.length-1;s>=0;s--)this._childClusters[s]._restorePosition();else for(var n=this._childClusters.length-1;n>=0;n--)this._childClusters[n]._recursivelyRestoreChildPositions(t)},_restorePosition:function(){this._backupLatlng&&(this.setLatLng(this._backupLatlng),delete this._backupLatlng)},_recursivelyRemoveChildrenFromMap:function(t,i,e){var s,n;this._recursively(t,-1,i-1,function(t){for(n=t._markers.length-1;n>=0;n--)s=t._markers[n],e&&e.contains(s._latlng)||(t._group._featureGroup.removeLayer(s),s.setOpacity&&s.setOpacity(1))},function(t){for(n=t._childClusters.length-1;n>=0;n--)s=t._childClusters[n],e&&e.contains(s._latlng)||(t._group._featureGroup.removeLayer(s),s.setOpacity&&s.setOpacity(1))})},_recursively:function(t,i,e,s,n){var r,o,a=this._childClusters,h=this._zoom;if(i>h)for(r=a.length-1;r>=0;r--)o=a[r],t.intersects(o._bounds)&&o._recursively(t,i,e,s,n);else if(s&&s(this),n&&this._zoom===e&&n(this),e>h)for(r=a.length-1;r>=0;r--)o=a[r],t.intersects(o._bounds)&&o._recursively(t,i,e,s,n)},_recalculateBounds:function(){var t,i=this._markers,e=this._childClusters;for(this._bounds=new L.LatLngBounds,delete this._wLatLng,t=i.length-1;t>=0;t--)this._expandBounds(i[t]);for(t=e.length-1;t>=0;t--)this._expandBounds(e[t])},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});