L.KML=L.FeatureGroup.extend({options:{async:!0},initialize:function(e,t){L.Util.setOptions(this,t),this._kml=e,this._layers={},e&&this.addKML(e,t,this.options.async)},loadXML:function(e,t,n,r){void 0==r&&(r=this.options.async),void 0==n&&(n=this.options);var o=new window.XMLHttpRequest;o.open("GET",e,r);try{o.overrideMimeType("text/xml")}catch(a){}o.onreadystatechange=function(){4==o.readyState&&200==o.status&&t(o.responseXML,n)},o.send(null)},addKML:function(e,t,n){var r=this,o=function(e,t){r._addKML(e,t)};this.loadXML(e,o,t,n)},_addKML:function(e){var t=L.KML.parseKML(e);if(t&&t.length){for(var n=0;n<t.length;n++)this.fire("addlayer",{layer:t[n]}),this.addLayer(t[n]);this.latLngs=L.KML.getLatLngs(e),this.fire("loaded")}},latLngs:[]}),L.Util.extend(L.KML,{parseKML:function(e){for(var t,n=this.parseStyle(e),r=e.getElementsByTagName("Folder"),o=[],a=0;a<r.length;a++)this._check_folder(r[a])&&(t=this.parseFolder(r[a],n),t&&o.push(t));r=e.getElementsByTagName("Placemark");for(var i=0;i<r.length;i++)this._check_folder(r[i])&&(t=this.parsePlacemark(r[i],e,n),t&&o.push(t));return o},_check_folder:function(e,t){for(e=e.parentElement;e&&"Folder"!==e.tagName;)e=e.parentElement;return!e||e===t},parseStyle:function(e){function t(e){for(var n={},r=0;r<e.childNodes.length;r++){var a=e.childNodes[r],i=a.tagName;if(o[i])if("hotSpot"===i)for(var s=0;s<a.attributes.length;s++)n[a.attributes[s].name]=a.attributes[s].nodeValue;else{var l=a.childNodes[0].nodeValue;"color"===i?(n.opacity=parseInt(l.substring(0,2),16)/255,n.color="#"+l.substring(2,8)):"width"===i?n.weight=l:"Icon"===i?(c=t(a),c.href&&(n.href=c.href)):"href"===i&&(n.href=l)}}return n}for(var n={},r=e.getElementsByTagName("Style"),o={color:!0,width:!0,Icon:!0,href:!0,hotSpot:!0},a=0;a<r.length;a++){var i,s=r[a],l={},h={},c={};i=s.getElementsByTagName("LineStyle"),i&&i[0]&&(l=t(i[0])),i=s.getElementsByTagName("PolyStyle"),i&&i[0]&&(h=t(i[0])),h.color&&(l.fillColor=h.color),h.opacity&&(l.fillOpacity=h.opacity),i=s.getElementsByTagName("IconStyle"),i&&i[0]&&(c=t(i[0])),c.href&&(l.icon=new L.KMLIcon({iconUrl:c.href,shadowUrl:null,iconAnchorRef:{x:c.x,y:c.y},iconAnchorType:{x:c.xunits,y:c.yunits}})),n["#"+s.getAttribute("id")]=l}return n},parseFolder:function(e,t){var n,r,o=[];n=e.getElementsByTagName("Folder");for(var a=0;a<n.length;a++)this._check_folder(n[a],e)&&(r=this.parseFolder(n[a],t),r&&o.push(r));n=e.getElementsByTagName("Placemark");for(var i=0;i<n.length;i++)this._check_folder(n[i],e)&&(r=this.parsePlacemark(n[i],e,t),r&&o.push(r));if(o.length)return 1===o.length?o[0]:new L.FeatureGroup(o)},parsePlacemark:function(e,t,n){var r,o,a,i={};for(a=e.getElementsByTagName("styleUrl"),r=0;r<a.length;r++){var s=a[r].childNodes[0].nodeValue;for(var l in n[s])i[l]=n[s][l]}var h=[],c=["LineString","Polygon","Point"];for(o in c){var d=c[o];for(a=e.getElementsByTagName(d),r=0;r<a.length;r++){var g=this["parse"+d](a[r],t,i);g&&h.push(g)}}if(h.length){var f=h[0];h.length>1&&(f=new L.FeatureGroup(h));var p,u,y="";for(a=e.getElementsByTagName("name"),a.length&&(p=a[0].childNodes[0].nodeValue),a=e.getElementsByTagName("description"),r=0;r<a.length;r++)for(o=0;o<a[r].childNodes.length;o++)u+=a[r].childNodes[o].nodeValue;for(a=e.getElementsByTagName("SimpleData"),r=0;r<a.length;r++)for(o=0;o<a[r].childNodes.length;o++)y=y+a[r].childNodes[o].nodeValue+"</br>";return y&&f.bindPopup(y),f}},parseCoords:function(e){var t=e.getElementsByTagName("coordinates");return this._read_coords(t[0])},parseLineString:function(e,t,n){var r=this.parseCoords(e);if(r.length)return new L.Polyline(r,n)},parsePoint:function(e,t,n){var r=e.getElementsByTagName("coordinates");if(r.length){var o=r[0].childNodes[0].nodeValue.split(",");return new L.KMLMarker(new L.LatLng(o[1],o[0]),n)}},parsePolygon:function(e,t,n){var r,o,a,i=[],s=[];for(r=e.getElementsByTagName("outerBoundaryIs"),o=0;o<r.length;o++)a=this.parseCoords(r[o]),a&&i.push(a);for(r=e.getElementsByTagName("innerBoundaryIs"),o=0;o<r.length;o++)a=this.parseCoords(r[o]),a&&s.push(a);return i.length?(n.fillColor&&(n.fill=!0),1===i.length?new L.Polygon(i.concat(s),n):new L.MultiPolygon(i,n)):void 0},getLatLngs:function(e){for(var t=e.getElementsByTagName("coordinates"),n=[],r=0;r<t.length;r++)n=n.concat(this._read_coords(t[r]));return n},_read_coords:function(e){var t,n="",r=[];for(t=0;t<e.childNodes.length;t++)n+=e.childNodes[t].nodeValue;for(n=n.split(/[\s\n]+/),t=0;t<n.length;t++){var o=n[t].split(",");o.length<2||r.push(new L.LatLng(o[1],o[0]))}return r}}),L.KMLIcon=L.Icon.extend({createIcon:function(){var e=this._createIcon("icon");return e.onload=function(){var t=new Image;t.src=this.src,this.style.width=t.width+"px",this.style.height=t.height+"px",("UNITS_FRACTION"===this.anchorType.x||"fraction"===this.anchorType.x)&&(e.style.marginLeft=-this.anchor.x*t.width+"px"),("UNITS_FRACTION"===this.anchorType.y||"fraction"===this.anchorType.x)&&(e.style.marginTop=-(1-this.anchor.y)*t.height+"px"),this.style.display=""},e},_setIconStyles:function(e,t){L.Icon.prototype._setIconStyles.apply(this,[e,t]),e.anchor=this.options.iconAnchorRef,e.anchorType=this.options.iconAnchorType}}),L.KMLMarker=L.Marker.extend({options:{icon:new L.KMLIcon.Default}});